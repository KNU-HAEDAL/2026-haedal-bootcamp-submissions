name: Check solved.ac AC Status

on:
  pull_request:
    paths:
      - 'problems/**'

jobs:
  solvedac-check:
    runs-on: ubuntu-latest
    steps:
      - name: Extract BOJ_ID from PR body (strict)
        id: get_id
        shell: bash
        run: |
          set -euo pipefail
          body="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"

          # "BOJ ì•„ì´ë””" ì„¹ì…˜ ì´í›„ ë¼ì¸ì—ì„œ ì²« ë²ˆì§¸ `...`ë§Œ ì¶”ì¶œ
          BOJ_ID="$(printf '%s\n' "$body" | awk '
            /### *.*BOJ *ì•„ì´ë””/ {flag=1; next}
            flag && match($0, /`([^`]+)`/, a) {print a[1]; exit}
          ')"

          if [ -z "${BOJ_ID:-}" ]; then
            echo "âŒ PR ë³¸ë¬¸ì—ì„œ BOJ ì•„ì´ë””ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. '### ğŸ‘¤ BOJ ì•„ì´ë””' ì•„ë˜ì— `ì•„ì´ë””` í˜•ì‹ìœ¼ë¡œ ì‘ì„±í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi

          echo "boj_id=$BOJ_ID" >> "$GITHUB_OUTPUT"
          echo "BOJ_ID=$BOJ_ID"

      - name: Verify required problems via solved.ac
        shell: bash
        run: |
          set -euo pipefail
          user="${{ steps.get_id.outputs.boj_id }}"
          required=(10988 10872 10811 2003 10814 1152 10828 2164)
          missing=()

          for pid in "${required[@]}"; do
            # '+' ëŒ€ì‹  '%20'(ê³µë°±) ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬ ì•ˆì •í™”
            q="s@${user}%20id:${pid}"

            # ë„¤íŠ¸ì›Œí¬ ìˆœê°„ ì´ìŠˆ ëŒ€ë¹„ ê°„ë‹¨ ì¬ì‹œë„
            count="$(
              for i in 1 2 3; do
                resp="$(curl -sSf "https://solved.ac/api/v3/search/problem?query=${q}" || true)"
                if [ -n "$resp" ]; then
                  echo "$resp" | jq -r '.count'
                  break
                fi
                sleep 1
              done
            )"

            if [ -z "${count:-}" ] || ! [[ "$count" =~ ^[0-9]+$ ]]; then
              echo "âŒ solved.ac ì‘ë‹µì´ ë¹„ì •ìƒì…ë‹ˆë‹¤. user=$user, pid=$pid"
              exit 1
            fi

            if [ "$count" -eq 0 ]; then
              missing+=("$pid")
            fi
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "âŒ ì•„ì§ solved.ac ê¸°ì¤€ìœ¼ë¡œ ACê°€ í™•ì¸ë˜ì§€ ì•Šì€ ë¬¸ì œ: ${missing[*]}"
            exit 1
          else
            echo "âœ… ëª¨ë“  ë¬¸ì œ AC í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
          fi
